# 前言
计算机网络学习的核心就是网络协议的学习。那么什么是网络协议？

网络协议是为计算机网络中进行数据交换而建立的规则、标准的集合，是一种人为的约定。

比如说不同的计算机之间，很可能使用着不同的字符集，那么他们之间传输数据，就会出现问题。一个电脑上显示的“你好世界”，到另一个电脑上可能就变成了“烫烫烫”。所以传输数据，必须通过协议进行。

目前，互联网普遍使用TCP/IP协议

# OSI网络模型
以下是对模型的图文解释

![](./src/CN_1.png)
![](./src/CN_2.jpg)
在该模型的每一层中都会有一个专属协议，完成该层的工作，并向上下层传输数据。

接下来我们以OSI网络模型对计算机网络进行学习：
# 物理层
该层用来提供可靠的物理媒介用于稳定安全地传输原始数据
以下是物理层的各种设备：
## 中继器-物理层
中继器（RP repeater）是对信号进行再生和还原的网络设备。适用于完全相同的两类网络的互连，主要功能是通过对数据信号的重新发送或者转发，来扩大网络传输的距离。

## 集线器-物理层
集线器（HUB）就是将网线集中到一起的机器，也就是多台主机和设备的连接器。集线器的主要功能也有扩大网络的传输距离，他是中继器的一种形式。区别在于集线器能够提供多端口服务，所以也被称为多口中继器。
集线器的基本功能是信息分发，它把一个端口接收的所有信号向所有端口分发出去。一些集线器在分发之前将弱信号重新生成，一些集线器整理信号的时序以提供所有端口间的同步数据通信。

## 交换机-数据链路层
交换机(Switch) 也叫交换式集线器，是的，它是集线器的plus版。它通过对信息进行重新生成，并经过内部处理后转发至指定端口，具备自动寻址能力和交换作用。
由于交换机根据所传递信息包的目的地址，将每一信息包独立地从源端口送至目的端口，避免了和其他端口发生碰撞。
广义的交换机就是一种在通信系统中完成信息交换功能的设备。 

## 路由器-网络层
路由器(Router)是网络中进行网间连接的关键设备。作为不同网络之间互相连接的枢纽，路由器系统构成了基于 TCP/IP 的国际互连网络 Internet 的主体脉络。 
路由器的基本功能是，把数据（IP 报文）传送到正确的网络，细分则包括：

1.IP 数据报的转发，包括数据报的寻径和传送；
2.子网隔离，抑制广播风暴；
3.维护路由表，并与其它路由器交换路由信息，这是 IP 报文转发的基础；
4.IP 数据报的差错处理及简单的拥塞控制；
5.实现对 IP 数据报的过滤和记帐; 

# 数据链路层
数据链路层为上层在不可靠的物理介质上提供可靠的传输。
>物理层：我很可靠
>数据链路层：不，你不可靠，我才可靠

该层主要有以下几个作用：
- 物理地址寻址
- 数据的成帧
- 流量控制
- 数据的检错和重发

## 封装成帧
帧是该层的数据的基本单位，是一串数据。该层传输数据使用透明传输的原则，也就是控制字符和要传输的数据储存在同一个帧里面，但是在读取的时候会无视控制字符

## 如何检错
- 奇偶校验码：以二进制方式。统计帧里面有几个1，然后在头添加0或1进行标记，说明该帧有几个1。如果检查时发现不对，说明该帧数据出错
- 循环冗余检验码：根据传输或保存的数据而产生固定位数校验码。
## 最大传输单位MTU
最大传输单位(Maximum Transmission Unit)，这是用来确定帧的大小的，取决于具体的物理设备。相当于物理设备是公路，公路多宽就是MTU。显然，当传输时看最窄的那个，也就是取最小的MTU作为整个数据链路层的MTU。

## 以太网协议
这个协议就是数据链路层所使用的协议，我们来看该协议下的数据帧大概长什么样：
![](./src/CN_3.png)
- 类型：用来标识上层使用的是什么协议
- 目的地址和源地址：使用MAC地址
- 数据：使用上层协议封装起来的数据
- CRC：循环冗余码
- 最短的帧：以太网规定最短帧应该是64节 
### MAC地址
是一组长为6字节的数。MAC地址要求每个网络适配器都必须有唯一的MAC地址（唯一性）

MAC广播地址：FF-FF-FF-FF-FF-FF

# 网络层
网络层的目的是实现两个端系统之间的数据透明传送。

网络层的功能包括寻址和路由选择、连接的建立、保持和终止等。此外，网络层还可以实现拥塞控制、网际互连等功能；

网络层中包含了众多协议且非常重要，其中最重要的协议就是IP协议

网络层的基本数据单位为IP数据段

几个重要协议：
- IP协议（Internet Protocol，因特网互联协议）;
- ICMP协议（Internet Control Message Protocol，因特网控制报文协议）;
- ARP协议（Address Resolution Protocol，地址解析协议）;
- RARP协议（Reverse Address Resolution Protocol，逆地址解析协议）。

## IP协议讲解
IP协议有什么意义：IP协议使得复杂的实际网络变为一个虚拟互联的网络；并且解决了在虚拟网络中数据报传输路径的问题。
### IP数据报
它是怎么做到的，看一下IP数据报的首部（首部后面跟着要传输的数据，因为放在前面，就叫首部）就可以明白大概的实现原理了
|位      |4   |   8 |  16 | 19 |   24 |31   |
|:----: | :-: | :-: | :-: | :-: | :-: | :-: |
|4字节  |版本 |首部长度|区分服务|总长度|总长度|总长度|
|8字节|标识  |标识    | 标识   |标志  |片偏移|片偏移|
|12字节|生存时间|生存时间|协议|首部检查和|首部检查和|首部检查和|
|16字节|源地址|源地址|源地址|源地址|源地址|源地址|
|20字节|目的地址|目的地址|目的地址|目的地址|目的地址|目的地址|
|更多字节|填充的内容|看情况填充|填充|填充|填充|填充|

显然IP数据报最小必须要有20个字节的首部。

### IP地址
只需要给现实中的每个主机分配唯一的IP地址就可以构筑一个虚拟网络，通过IP地址来找到真实的主机

IP地址分为网络号码和主机号码两个部分，同一个物理网络下的所有主机的网络号码一定是一样的，那么什么是网络号码和主机号码，让我们看一下IP地址的分类就可以了。
![](./src/CN_4.png)

|类别|	IP范围|	子网掩码|	描述|
| :-: | :-: | :-: | :-: |
|A类（1~126）|1.0.0.1 ~ 127.255.255.254|	255.0.0.0|共有126个网络，每个网络可以有1600万台主机，适合大规模的网络|
|B类（128~191）|128.0.0.1 ~ 191.255.255.254|255.255.0.0	|共有16384个网络，每个网络可以有6万台主机，适合中等规模的网络|
|C类（192~223）|192.0.0.1 ~ 233.255.255.254	|255.255.255.0|共有209万个网络，每个网络可以有254台主机，适合小型网络|
|D类（224~239）|224.0.0.0 ~ 239.255.255.255| 	|组播地址|
|E类（240~255）|240.0.0.0 ~ 255.255.255.254|	 |保留地址|

这里面又牵扯到一个问题，什么是子网掩码。
实际上，随着网络的发展，上面的IP地址划分实在是浪费空间。因为前面几个数是固定用来表示IP地址类型的，这意味着IP地址不是纯粹放置着网络号和主机号。

在这样一种情况下，子网掩码诞生了。子网掩码用来在二进制下标识一组IP地址中哪个是网络号，哪个是主机号。所以才有了表中A类地址的掩码是255.0.0.0
因为在二进制下我们看子网掩码和IP地址：
```cpp
//子网掩码
11111111 00000000 00000000 00000000 
//IP地址
00000001 00000000 00000000 00000001
```
只要将子网掩码与IP地址进行按位与操作，就可以得到IP地址中的网络号，而且完美满足了A类地址要求的前8位是网络号的要求。所以A类地址的子网掩码是255.0.0.0.以此类推，B类C类的掩码也是一样的道理

### 私有IP地址
IP地址也分私有和公有，私有用于内部使用，只有公有是可以获得和申请的。
以下是所有私有地址：
A类 10.0.0.0–10.255.255.255，1个

B类 172.16.0.0–172.31.255.255，16个

C类 192.168.0.0–192.168.255.255，255个
>特殊地址除外，它就是不允许获取


## NAT技术
为什么会有外网和内网的说法，这一说法的来源就是NAT技术。

根据NAT技术，给企业或家庭所使用局域网下的所有主机的IP地址，都是私有网络。当它们想要访问互联网时，只能通过一个公有IP地址来连接互联网。而公有IP是由运营商维护的。

NAT技术在网关这个设备上实现。私有地址访问互联网时，会先在网关中将私有IP对应到一个公有IP上。注意，目标地址是不变的，变化的是源地址。

也就是说，当你想访问百度时，你的数据会经历以下步骤
1. 在网关处将源地址从私有地址改变为公有地址。
2. 根据目标地址进行发送。
3. 百度服务器接收数据并处理，返回数据的目标地址是原来的源地址。
4. 网关接收到了返回的数据，并将目标地址从公有地址改变为私有地址。
5. 网关根据私有地址将数据发送到你的电脑上。

这里最关键的技术就是该怎么将私有地址转换为公有地址。与之对应的有静态NAT、动态NAT、NATP、Easy IP、Server-NAT 。

- 静态NAT，顾名思义，一个私有地址对应一个公有地址，不会改变
- 动态NAT，网关会动态分配私有地址对应的公有地址，当私有地址长时间不访问时，就认为不需要，解除映射
- NATP，多个私有地址会映射到同一个公有地址下的不同端口，大大提升利用率
- Easy IP，将私有地址分配到网关的不同端口上，和NATP有点像。
- Server-NAT，让公网能够连接到私有地址对应的主机，让你的电脑也能成为服务器并被互联网连接。

## ARP/RARP协议
用来将IP地址和MAC地址进行关联，也就是说，它是用来给网络层和数据链路层沟通的工具。没有了它，网络层和数据链路层互相无法交换数据。
- ARP为网卡（网络适配器）的IP地址到对应的硬件地址提供动态映射，也就是从网络层到数据链路层。
- RARP指逆地址解析协议，可以把数据链路层MAC48位地址转化为网络层32位地址。也就是从数据链路层到网络层。
>通常ARP是即插即用，管理员不需要关注ARP表是如何将IP地址和MAC地址关联（这都要关注那也太浪费时间了）
## ICMP协议
![](./src/CN_5.png)

和数据链路层用来查错的套路一样，在真正要传输的数据前加一串东西用来报告错误信息或者异常情况

注意，它记录的是传输过程中遇到的各种错误信息，所以可以通过它追溯传输路径和排查bug。

## 网络层如何路由
这里会说到Dij算法，是的。我们需要找到一种路由算法来确定数据传输时要怎么走。

### 内部网关-RIP协议
路由信息协议 RIP(Routing Information Protocol)，基于距离-向量的路由选择算法，较小的AS（自治系统），适合小型网络；RIP报文，封装进UDP数据报。

RIP协议特性：

- RIP在度量路径时采用的是跳数（每个路由器维护自身到其他每个路由器的距离记录）；
- RIP的费用定义在源路由器和目的子网之间；
- RIP被限制的网络直径不超过15跳；
- 和隔壁交换所有的信息，30主动一次（广播）。

### 内部网关-OSPF协议

开放最短路径优先协议 OSPF(Open Shortest Path First)，基于链路状态的路由选择算法（即Dijkstra算法），较大规模的AS ，适合大型网络，直接封装在IP数据报传输。

OSPF协议优点：

- 安全；
- 支持多条相同费用路径；
- 支持区别化费用度量；
- 支持单播路由和多播路由；
- 分层路由。
### OSPF与RIP比较
![这里有一个图片](./src/CN_6.png)

### 外部网关-BGP
BGP（Border Gateway Protocol）边际网关协议：是运行在AS之间的一种协议,寻找一条好路由：首次交换全部信息，以后只交换变化的部分,BGP会封装进TCP报文段.

# 传输层
传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输。此外，传输层还要处理端到端的差错控制和流量控制问题。

网络层只是根据网络地址将源结点发出的数据包传送到目的结点，而传输层则负责将数据可靠地传送到相应的端口。